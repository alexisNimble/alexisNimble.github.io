<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Initial DataLayer Configuration -->
    <script>
        window.dataLayer = window.dataLayer || [];
    </script>

    <!-- Google Tag Manager -->
    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5HNTJGHR');
    </script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YJ8REY8VPG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YJ8REY8VPG');
    </script>

    <title>Test de User Properties en GA4</title>
    <style>
        /* ... (mismo CSS que antes) ... */
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5HNTJGHR" height="0" width="0"
            style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <h1>Test de User Properties en GA4</h1>
        
        <div class="button-group">
            <button onclick="sendCustomEvent('test_event_1')" class="primary">
                Evento de Prueba 1
            </button>
            
            <button onclick="sendCustomEvent('test_event_2')" class="secondary">
                Evento de Prueba 2
            </button>
            
            <button onclick="updateUserRole()" class="success">
                Actualizar Rol de Usuario
            </button>
        </div>

        <div class="event-log">
            <h3>Registro de Eventos:</h3>
            <div id="eventLog"></div>
        </div>
    </div>

    <script>
        // Función para esperar a que gtag esté disponible
        function waitForGtag(callback, maxAttempts = 10) {
            let attempts = 0;
            const checkGtag = () => {
                attempts++;
                if (typeof gtag === 'function') {
                    // Configurar user properties una vez que gtag esté disponible
                    gtag('set', 'user_properties', {
                        user_role: 'administrator'
                    });
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(checkGtag, 500);
                } else {
                    console.error('No se pudo cargar gtag después de múltiples intentos');
                }
            };
            checkGtag();
        }

        // Función para registrar eventos en la UI
        function logEvent(eventDetails) {
            const logDiv = document.getElementById('eventLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${JSON.stringify(eventDetails)}`;
            logDiv.insertBefore(logEntry, logDiv.firstChild);
        }

        // Función para enviar eventos tanto a GA4 como al dataLayer
        function sendCustomEvent(eventName) {
            const eventParams = {
                event_category: 'user_interaction',
                event_label: eventName
            };

            // Primero, enviar al dataLayer
            dataLayer.push({
                'event': eventName,
                ...eventParams
            });

            // Luego, intentar enviar a GA4 directamente si está disponible
            if (typeof gtag === 'function') {
                gtag('event', eventName, eventParams);
            }

            // Registrar en la UI
            logEvent({
                event: eventName,
                ...eventParams
            });
        }

        // Función para actualizar user properties
        function updateUserRole() {
            const roles = ['administrator', 'editor', 'viewer'];
            const currentRole = document.querySelector('.success').textContent.includes('administrator') ? 
                'editor' : document.querySelector('.success').textContent.includes('editor') ? 
                'viewer' : 'administrator';

            // Actualizar en dataLayer
            dataLayer.push({
                'event': 'user_role_updated',
                'user_role': currentRole
            });

            // Actualizar en GA4 si está disponible
            if (typeof gtag === 'function') {
                gtag('set', 'user_properties', {
                    user_role: currentRole
                });
            }

            // Actualizar texto del botón
            document.querySelector('.success').textContent = `Rol Actual: ${currentRole}`;

            // Registrar en la UI
            logEvent({
                event: 'user_role_updated',
                new_role: currentRole
            });
        }

        // Inicializar cuando el documento esté listo
        document.addEventListener('DOMContentLoaded', () => {
            waitForGtag(() => {
                console.log('GA4 inicializado correctamente');
                document.querySelector('.success').textContent = 'Rol Actual: administrator';
            });
        });
    </script>
</body>
</html>
